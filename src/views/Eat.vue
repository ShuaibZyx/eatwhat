<template>
  <el-card>
    <div class="eat">
      <!-- ËΩÆÊí≠Âõæ -->
      <el-carousel :interval="4000" type="card">
        <el-carousel-item v-for="(item, index) in carouselData" :key="index">
          <el-tooltip
            class="item"
            effect="light"
            placement="bottom"
            :enterable="false"
            :content="'Êü•Áúã' + item.menuName"
          >
            <div class="carousel" @click="getMenuCompose(item.menuEle, item)">
              <span>{{ item.menuCuis }} : {{ item.menuName }}‚ú®</span>
              <el-image
                :src="item.menuPut"
                fit="contain"
                style="border-radius: 7px; overflow: hidden"
              ></el-image>
            </div>
          </el-tooltip>
        </el-carousel-item>
      </el-carousel>

      <!-- ‰∏ª‰ΩìÂå∫ÂüüÂÜÖÂÆπ -->
      <div class="main-content">
        <!-- ÊêúÁ¥¢‰ª•ÂèäÊ†áÁ≠æÂå∫Âüü -->
        <div class="search">
          <div class="category">
            <div class="cuis">
              <span>ËèúÁ≥ª: </span>
              <el-tag
                type="parmary"
                style="margin: 7px; cursor: pointer"
                v-for="(item, index) in menuCuis"
                :key="index"
                @click="changeSearchCondition(item, 'menuCuis')"
                >{{ item }}</el-tag
              >
            </div>
            <!-- ËèúË∞±Âè£Âë≥ -->
            <div class="taste">
              <span>Âè£Âë≥: </span>
              <el-tag
                type="warning"
                style="margin: 7px; cursor: pointer"
                v-for="(item, index) in menuTaste"
                :key="index"
                @click="changeSearchCondition(item, 'menuTaste')"
              >
                {{ item }}</el-tag
              >
            </div>
          </div>
          <div class="btn">
            <el-autocomplete
              v-model="search"
              :debounce="2000"
              placement="bottom-end"
              :fetch-suggestions="querySearch"
              placeholder="ËØ∑ËæìÂÖ•ÂÜÖÂÆπ"
              @keyup.enter.native="searchMenu"
            >
              <el-button
                slot="append"
                icon="el-icon-search"
                @click="searchMenu"
              ></el-button>
            </el-autocomplete>

            <div
              class="choosed-category"
              v-if="
                choosedCategory[0].value !== '' ||
                choosedCategory[1].value !== ''
              "
            >
              <span>Â∑≤ÈÄâÊ†áÁ≠æ: </span>
              <el-tag
                style="margin: 7px; cursor: pointer"
                type="success"
                v-for="(item, index) in choosedCategory"
                :key="index"
                >{{ item.value || "ÊöÇÊó†" }}</el-tag
              >
            </div>
          </div>
        </div>

        <!-- ‰∏ª‰ΩìËèúË∞±Â±ïÁ§∫Âå∫Âüü -->

        <!-- ËèúË∞±Â±ïÁ§∫Âå∫Âüü -->
        <div class="show">
          <!-- ÊØè‰∏Ä‰∏™ËèúË∞±ÁöÑÂ±ïÁ§∫ÁõíÂ≠ê -->
          <el-tooltip
            class="item"
            effect="light"
            placement="top"
            :enterable="false"
            v-for="(item, index) in menuPart"
            :key="index"
            :content="'Êü•Áúã' + item.menuName"
          >
            <div class="menu-box" @click="getMenuCompose(item.menuEle, item)">
              <!-- ÁõíÂ≠êÂõæÁâá -->
              <div class="img-box">
                <el-image
                  style="width: 100%"
                  :src="item.menuPut"
                  fit="contain"
                  lazy
                ></el-image>
              </div>
              <!-- ÁõíÂ≠êÊñáÂ≠ó‰ªãÁªç -->
              <div class="title">
                <span>{{ item.menuName }}</span>
              </div>
            </div>
          </el-tooltip>
        </div>

        <!-- ÂñúÂ•ΩÊé®ËçêÂå∫Âüü -->
        <span class="userLikeMenu">Ê†πÊçÆÊÇ®ÁöÑÂñúÂ•Ω‰∏∫ÊÇ®Êé®Ëçê: </span>
        <div class="show" style="height: auto !important">
          <span v-if="userLikeMenu.length === 0">ÊöÇÊó†Êï∞ÊçÆü•∂</span>
          <!-- ÊØè‰∏Ä‰∏™ËèúË∞±ÁöÑÂ±ïÁ§∫ÁõíÂ≠ê -->
          <el-tooltip
            class="item"
            effect="light"
            placement="top"
            :enterable="false"
            v-for="(item, index) in userLikeMenu"
            :key="index"
            :content="'Êü•Áúã' + item.menuName"
          >
            <div class="menu-box" @click="getMenuCompose(item.menuEle, item)">
              <!-- ÁõíÂ≠êÂõæÁâá -->
              <div class="img-box">
                <el-image
                  style="width: 100%"
                  :src="item.menuPut"
                  fit="contain"
                  lazy
                ></el-image>
              </div>
              <!-- ÁõíÂ≠êÊñáÂ≠ó‰ªãÁªç -->
              <div class="title">
                <span>{{ item.menuName }}</span>
              </div>
            </div>
          </el-tooltip>
        </div>
      </div>
    </div>

    <!-- Áî®Êà∑‰ø°ÊÅØÊäΩÂ±â -->
    <el-drawer
      title="ÊàëÁöÑ‰ø°ÊÅØ"
      :visible.sync="userInfoVisible"
      direction="btt"
      size="40%"
      ref="drawer"
    >
      <div class="drawer-content">
        <div class="userInfo">
          <el-form
            :model="user"
            label-width="80px"
            size="small"
            ref="userFormRef"
            :rules="userFormRules"
          >
            <div class="left" style="width: 40%">
              <el-form-item label="ÊòµÁß∞" prop="userName">
                <el-input
                  prefix-icon="el-icon-user-solid"
                  v-model="user.userName"
                  autocomplete="off"
                  maxlength="8"
                  :clearable="true"
                ></el-input>
              </el-form-item>

              <el-form-item label="ÁîµËØù" prop="userNumb">
                <el-input
                  v-model.number="user.userNumb"
                  autocomplete="off"
                  prefix-icon="el-icon-phone"
                  :clearable="true"
                  maxlength="11"
                  :disabled="true"
                ></el-input>
              </el-form-item>

              <el-form-item label="‰ΩèÂùÄ" prop="userAdd">
                <el-cascader
                  style="width: 100%"
                  v-model="user.userAdd"
                  :options="citys"
                  filterable
                  clearable
                  :props="{ expandTrigger: 'hover' }"
                ></el-cascader>
              </el-form-item>
            </div>

            <div class="right" style="width: 40%">
              <el-form-item label="ÊÄßÂà´" prop="userGend">
                <el-radio-group v-model="user.userGend">
                  <el-radio label="Áî∑">Áî∑</el-radio>
                  <el-radio label="Â•≥">Â•≥</el-radio>
                </el-radio-group>
              </el-form-item>

              <el-form-item label="ÂñúÂ•Ω">
                <el-tag
                  :key="tag"
                  style="margin: 5px"
                  v-for="tag in dynamicUserLikeTags"
                  closable
                  :disable-transitions="false"
                  @close="handleUserLikeClose(tag)"
                >
                  {{ tag }}
                </el-tag>
                <el-input
                  class="input-new-tag"
                  v-if="inputUserLikeVisible"
                  v-model="inputUserLikeValue"
                  ref="saveTagInput"
                  size="small"
                  @keyup.enter.native="handleInputConfirm"
                  @blur="handleInputConfirm"
                >
                </el-input>
                <el-button
                  v-else
                  class="button-new-tag"
                  size="small"
                  @click="showInput"
                  >+ ÂñúÂ•Ω</el-button
                >
              </el-form-item>
            </div>
            <div class="progress" style="width: 20%">
              <el-progress
                type="circle"
                :percentage="percentage"
                :width="160"
                :color="colors"
                :status="percentageState"
              ></el-progress>
            </div>
          </el-form>
        </div>
        <div class="demo-drawer__footer">
          <el-button type="info" size="small" @click="getUser">Èáç ÁΩÆ</el-button>
          <el-button type="primary" size="small" @click="editUserPassword"
            >‰øÆÊîπÂØÜÁ†Å</el-button
          >
          <el-button type="success" size="small" @click="updateUserInfo"
            >Á°Æ ÂÆö</el-button
          >
        </div>
      </div>
    </el-drawer>

    <!-- Â±ïÁ§∫ËèúË∞±ËØ¶ÁªÜ‰ø°ÊÅØÁöÑdialog -->
    <el-dialog
      :title="menuObj.menuName"
      :visible.sync="menuInfoDialogVisible"
      width="65%"
    >
      <div class="menuInfo">
        <div class="menuMain">
          <div class="menuImg">
            <el-image
              style="width: 100%"
              :src="menuObj.menuPut"
              :preview-src-list="menuPreImgs"
              fit="contain"
              lazy
            ></el-image>
          </div>
          <div class="menuPrime">
            <span>ËèúË∞±ÂêçÁß∞: {{ menuObj.menuName }}</span>
            <span>ËèúÁ≥ª: {{ menuObj.menuCuis }}</span>
            <span>Âè£Âë≥: {{ menuObj.menuTaste }}</span>
          </div>
        </div>
        <div class="menuOther">
          <div class="menuLevel">
            <span style="margin-right: 12px">‰∏äÊâãÈöæÂ∫¶: </span>
            <el-rate v-model="menuObj.menuLevel" disabled text-color="#ff9900">
            </el-rate>
          </div>
          <div class="menuPrice">
            <span>‰ª∑Ê†º: {{ menuObj.menuPrice }} ÂÖÉ</span>
          </div>
        </div>
        <div class="menuComposeTable">
          <span>ËèúË∞±ÁªÑÊàê: </span>
          <el-table
            :data="menuObj.menuEle"
            :highlight-current-row="true"
            style="width: 100%"
            height="300"
            :stripe="true"
            :border="true"
            size="small"
            fit
          >
            <el-table-column label="È£üÊùêÂõæÁâá" width="120" align="center">
              <template slot-scope="scope">
                <el-image
                  style="width: 100%"
                  :src="scope.row.ingrePut"
                  fit="contain"
                  :preview-src-list="ingredientPreImgs"
                ></el-image>
              </template>
            </el-table-column>
            <el-table-column label="È£üÊùêÂêçÁß∞" prop="ingreName" align="center">
            </el-table-column>
            <el-table-column label="È£üÊùê‰∫ßÂú∞" width="280" align="center">
              <template slot-scope="scope">
                <el-tag
                  style="margin-right: 7px"
                  v-for="(item, index) in scope.row.ingreAdd.split('/')"
                  :key="index"
                  size="mini"
                  type="primary"
                  effect="dark"
                  >{{ item }}</el-tag
                >
              </template>
            </el-table-column>
            <el-table-column label="È£üÊùêÂ±ûÊÄß" prop="ingreAttr" align="center">
            </el-table-column>
            <el-table-column label="È£üÊùê‰ª∑Ê†º" align="center">
              <template slot-scope="scope">
                <span>{{ scope.row.ingrePrice }} ÂÖÉ</span>
              </template>
            </el-table-column>
          </el-table>
        </div>
        <div class="menuBrief">
          <span>ËèúË∞±ÁÆÄ‰ªãÂèäÂà∂‰ΩúÊ≠•È™§: </span>
          <el-input
            type="textarea"
            :rows="7"
            placeholder="ËèúË∞±ÁÆÄ‰ªã"
            v-model="menuObj.menuBrief"
          >
          </el-input>
        </div>
      </div>
    </el-dialog>
  </el-card>
</template>

<script>
import citys from "../js/citys";
export default {
  name: "Eat",
  data() {
    return {
      //ËΩÆÊí≠ÂõæÊï∞ÊçÆ
      carouselData: [],
      //ËèúË∞±Êï∞ÁªÑ
      menu: [],
      //ËèúË∞±ÂÆûÈôÖÂ±ïÁ§∫Êï∞ÁªÑ
      menuPart: [],
      //ÊêúÁ¥¢Êù°‰ª∂
      search: "",
      //ÊêúÁ¥¢ÂÖ≥ÈîÆËØçÊé®ËçêÊï∞ÁªÑ
      searchRecommend: [],
      //ÂΩìÂâçÁî®Êà∑
      user: {
        userId: "",
        userPwd: "123456",
        userName: "Á•ûÁßò‰∫∫",
        userNumb: "",
        userLike: "",
        userAdd: "",
        userGend: "Áî∑",
      },
      //Áî®Êà∑Êï∞ÊçÆ‰øÆÊîπÊ†°È™åËßÑÂàô
      userFormRules: {
        userName: [
          { required: true, message: "ËØ∑ËæìÂÖ•Áî®Êà∑ÊòµÁß∞", trigger: "blur" },
          {
            min: 1,
            max: 8,
            message: "ÈïøÂ∫¶Âú® 1 Âà∞ 8 ‰∏™Â≠óÁ¨¶",
            trigger: "blur",
          },
        ],
        userNumb: [
          { required: true, message: "ËØ∑ËæìÂÖ•ÁîµËØùÂè∑Á†Å", trigger: "blur" },
          {
            pattern:
              /^((13[0-9])|(14[5-9])|(15([0-3]|[5-9]))|(16[6-7])|(17[1-8])|(18[0-9])|(19[1|3])|(19[5|6])|(19[8|9]))\d{8}$/,
            message: "ÊâãÊú∫Âè∑Á†ÅÊ†ºÂºè‰∏çÁ¨¶Âêà",
            trigger: "blur",
          },
        ],
        userAdd: [{ required: true, message: "‰ΩèÂùÄ‰∏çÂèØ‰∏∫Á©∫", trigger: "blur" }],
        userGend: [
          { required: true, message: "ÊÄßÂà´‰∏çÂèØ‰∏∫Á©∫", trigger: "blur" },
        ],
      },
      //Â∑≤ÈÄâÊã©ÁöÑÊ†áÁ≠æÊï∞ÁªÑ
      choosedCategory: [
        {
          category: "menuCuis",
          value: "ÂÖ®ÈÉ®",
        },
        {
          category: "menuTaste",
          value: "ÂÖ®ÈÉ®",
        },
      ],
      //ËèúÁ≥ªÊï∞ÁªÑ
      menuCuis: [
        "Â∑ùÊπòËèú",
        "È≤ÅËèú",
        "‰∏úÂåóËèú",
        "Ë•øÂåóËèú",
        "Á≤§Ëèú",
        "ÂæΩËèú",
        "Ë•øÈ§ê",
        "‰∏ªÈ£ü",
        "ÂÖ®ÈÉ®",
      ],
      //ËèúË∞±Âè£Âë≥
      menuTaste: [
        "Áîú",
        "ÈÖ∏",
        "Ëæ£",
        "Âí∏",
        "ÈÖ∏Ëæ£",
        "ÈÖ∏Áîú",
        "Ê∏ÖÊ∑°",
        "Ëã¶Ê∂©",
        "È≤úÈ¶ô",
        "ÂÖ®ÈÉ®",
      ],
      //ÂüéÂ∏ÇÊï∞ÊçÆ
      citys,
      //Áî®Êà∑‰ø°ÊÅØÂ°´ÂÜôËøõÂ∫¶ÊòæÁ§∫
      percentage: 0,
      //Áî®Êà∑Â°´ÂÜô‰ø°ÊÅØËøõÂ∫¶Êù°Áä∂ÊÄÅ
      percentageState: "warning",
      //Áî®Êà∑‰ø°ÊÅØÂ°´ÂÜôËøõÂ∫¶È¢úËâ≤
      colors: [
        { color: "#e6a23c", percentage: 25 },
        { color: "#1989fa", percentage: 50 },
        { color: "#1989fa", percentage: 75 },
        { color: "#5cb87a", percentage: 100 },
      ],
      //ËèúË∞±‰ø°ÊÅØÂ±ïÁ§∫ÊâÄÁî®dialogÂèØËßÅÊÄß
      menuInfoDialogVisible: false,
      //Ê≠§Êó∂Â±ïÁ§∫ÁöÑËèúË∞±‰ø°ÊÅØÂØπË±°
      menuObj: {
        menuName: "",
        menuEle: [],
        menuTaste: "",
        menuCuis: "",
        menuBrief: "",
        menuLevel: "",
        menuPut: "",
        menuPrice: "",
      },
      //ËèúË∞±Â§ßÂõæÊï∞ÁªÑ
      menuPreImgs: [],
      //ËèúË∞±ÁªÑÊàêÈ£üÊùêÂ§ßÂõæÊï∞ÁªÑ
      ingredientPreImgs: [],
      //Áî®Êà∑ÂñúÂ•ΩÊï∞ÁªÑ
      dynamicUserLikeTags: [],
      //Áî®Êà∑ÂñúÂ•ΩtagËæìÂÖ•Ê°ÜÂèØËßÅÊÄß
      inputUserLikeVisible: false,
      //Áî®Êà∑ÂÜçÂñúÂ•ΩËæìÂÖ•Ê°ÜÂÜÖËæìÂÖ•ÁöÑÂÄº
      inputUserLikeValue: "",
      //Áî®Êà∑ÂñúÂ•ΩÊé®ËçêËèúË∞±Êï∞ÁªÑ
      userLikeMenu: [],
    };
  },
  computed: {
    //Áî®Êà∑‰ø°ÊÅØÊäΩÂ±âÂèØËßÅÊÄß
    userInfoVisible: {
      get() {
        return this.$store.state.userInfoVisible;
      },
      set(val) {
        this.$store.commit("SetUserInfoVisible", val);
      },
    },
  },
  methods: {
    //Ëé∑ÂèñÊâÄÊúâËèúË∞±
    async getMenu() {
      const { data: menuRes } = await this.$http.get("menu");
      this.menu = menuRes.data;
      this.menuPart = this.menu;
      for (let i = 0; i < 6; i++) {
        this.carouselData.push(
          menuRes.data[parseInt(this.getRandom(menuRes.data.length))]
        );
      }
      menuRes.data.forEach((item) => {
        this.searchRecommend.push({
          value: item.menuName,
        });
        this.menuPreImgs.push(item.menuPut);
      });
    },

    //Ëé∑ÂæóÈöèÊú∫Êï∞ÁöÑÊñπÊ≥ï--Â≠òÂú®ÈáçÂ§çÈóÆÈ¢ò
    getRandom(length) {
      return Math.floor(Math.random() * length);
    },

    //ÊêúÁ¥¢Êù°‰ª∂‰∏ãÊãâÊ°ÜÂõûË∞É
    querySearch(queryString, cb) {
      var searchRecommend = this.searchRecommend;
      var results = queryString
        ? searchRecommend.filter(this.createFilter(queryString))
        : searchRecommend;
      // Ë∞ÉÁî® callback ËøîÂõûÂª∫ËÆÆÂàóË°®ÁöÑÊï∞ÊçÆ
      cb(results);
    },

    //ÊêúÁ¥¢ÊâÄÊúâËøáÊª§Âô®
    createFilter(queryString) {
      return (recommendMenu) => {
        return (
          recommendMenu.value
            .toLowerCase()
            .indexOf(queryString.toLowerCase()) === 0
        );
      };
    },

    //ÁÇπÂáªÊ†áÁ≠æÊñπÊ≥ï
    changeSearchCondition(item, category) {
      this.choosedCategory.forEach((e) => {
        if (e.category === category) {
          e.value = item;
        }
      });
      this.menuPart = this.menu;
      this.menuPart = this.myMenuFilter(
        this.choosedCategory[0].value,
        this.choosedCategory[1].value
      );
    },

    //ÈÄöËøáÊ†áÁ≠æËøáÊª§Áé∞ÊúâËèúË∞±ÁöÑÊñπÊ≥ï(ËøáÊª§Âô®)
    myMenuFilter(menuCuis, menuTaste) {
      return this.menu.filter(function (menu) {
        if (menuCuis === "ÂÖ®ÈÉ®" && menuTaste !== "ÂÖ®ÈÉ®") {
          return menu.menuTaste === menuTaste;
        } else if (menuTaste === "ÂÖ®ÈÉ®" && menuCuis !== "ÂÖ®ÈÉ®") {
          return menu.menuCuis === menuCuis;
        } else if (menuCuis === "ÂÖ®ÈÉ®" && menuTaste === "ÂÖ®ÈÉ®") {
          return menu;
        } else {
          return menu.menuCuis === menuCuis && menu.menuTaste === menuTaste;
        }
      });
    },

    //Ëé∑ÂèñÂΩìÂâçÁî®Êà∑
    async getUser() {
      var userId = JSON.parse(window.sessionStorage.getItem("user")).userId;
      const { data: userRes } = await this.$http.get("user/" + userId);
      this.user = userRes.data[0];
      this.user.userAdd = userRes.data[0].userAdd.split("/");
      this.dynamicUserLikeTags = this.user.userLike.split("|");
      //Áî®Êà∑‰ø°ÊÅØÂ°´ÂÜôËøõÂ∫¶
      this.percentage = 0;
      if (this.user.userName !== "") this.percentage += 25;
      if (this.user.userLike !== "") this.percentage += 25;
      if (this.user.userAdd.length >= 0) this.percentage += 25;
      if (this.user.userGend !== "") this.percentage += 25;
      if (this.percentage === 100) this.percentageState = "success";
    },

    //ÁÇπÂáªËèúË∞±ÊñπÊ≥ï,Ê®°Á≥äÊü•ËØ¢ËèúË∞±È£üÊùêÁªÑÊàê,ËÆ∞ÂΩïÁî®Êà∑ÂéÜÂè≤ËÆ∞ÂΩï
    async getMenuCompose(compose, menu) {
      if (typeof compose !== "string") {
        var menuElement = "";
        this.menuObj.menuEle.forEach((item) => {
          menuElement = menuElement + item.ingreName + "|";
        });
        menuElement = menuElement.slice(0, menuElement.lastIndexOf("|"));
        compose = menuElement;
      }
      const { data: menuComposeRes } = await this.$http.get(
        "ingredient/searchlike/" + compose
      );
      menu.menuEle = menuComposeRes.data;
      this.menuObj = menu;
      menuComposeRes.data.forEach((item) => {
        this.ingredientPreImgs.push(item.ingrePut);
      });
      this.menuInfoDialogVisible = true;

      //ÂºÄÂßãËÆ∞ÂΩï
      //È¶ñÂÖàÊü•ËØ¢ËØ•ËèúË∞±ÊòØÂê¶Â∑≤ÁªèÂ≠òÂú®
      //Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÊâÄÊúâËèúË∞±ÂéÜÂè≤ËÆ∞ÂΩï
      var userMenuRecord = this.userMenuRecord;
      //Âæ™ÁéØÊêúÁ¥¢ËØ•ËèúË∞±ÊòØÂê¶Â∑≤ÁªèË¢´ËÆ∞ÂΩï
      //ÊòØÂê¶Ë¢´ËÆ∞ÂΩïÊ†áÂøó
      var menuFlag = false;
      for (let i = 0; i < userMenuRecord.length; i++) {
        //Â¶ÇÊûúËØ•ËèúË∞±Âú®ËØ•Áî®Êà∑ÁöÑÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Â≠òÂú®
        if (userMenuRecord[i].menuId === menu.menuId) {
          this.updateMenuRecord(userMenuRecord[i].recordId);
          menuFlag = true;
          return;
        }
      }
      //Â¶ÇÊûúËØ•ËèúË∞±Ê≤°ÊúâË¢´ËØ•Áî®Êà∑ËÆ∞ÂΩïËøáÔºåÂàôÊñ∞ÂàõÂª∫‰∏ÄÊù°ËÆ∞ÂΩï
      if (!menuFlag) {
        var menuObj = {
          recordId: this.guid(),
          userId: this.user.userId,
          menuId: menu.menuId,
          createTime: this.getNowTime(),
        };
        this.addRecord(menuObj);
      }
      //Êõ¥Êñ∞Áî®Êà∑ËèúË∞±ÂéÜÂè≤ËÆ∞ÂΩï
      this.getUserMenuRecord();
      //Êõ¥Êñ∞ÂΩìÂâçÁî®Êà∑‰∏™‰∫∫ÂñúÂ•ΩÊé®ËçêËèúË∞±
      this.getRecommendUserLikeMenu();
    },

    //Ê∑ªÂä†Áî®Êà∑ÂéÜÂè≤ËÆ∞ÂΩïÊñπÊ≥ï
    async addRecord(menu) {
      const { data: addRecordRes } = await this.$http.post("record", menu);
      if (addRecordRes.code !== 200) {
        this.$message.error("Ê∑ªÂä†ËèúË∞±ÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•");
        return;
      }
      //Âà∑Êñ∞Áî®Êà∑ÂΩìÂâçËèúË∞±ÂéÜÂè≤ËÆ∞ÂΩï
      this.getUserMenuRecord();
      //Âà∑Êñ∞Áî®Êà∑ËèúË∞±Êé®Ëçê
      this.getRecommendUserLikeMenu();
    },

    //Êõ¥Êñ∞Â∑≤ÊúâËèúË∞±ÂéÜÂè≤ËÆ∞ÂΩï
    async updateMenuRecord(recordId) {
      const { data: updateMenuRecord } = await this.$http.put(
        "record/" + recordId
      );
      if (updateMenuRecord.code !== 200) {
        this.$message.error("Êõ¥Êñ∞ËèúË∞±ÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•");
        return;
      }
      //Âà∑Êñ∞Áî®Êà∑ÂΩìÂâçËèúË∞±ÂéÜÂè≤ËÆ∞ÂΩï
      this.getUserMenuRecord();
      //Âà∑Êñ∞Áî®Êà∑ËèúË∞±Êé®Ëçê
      this.getRecommendUserLikeMenu();
    },

    //Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ËèúË∞±ÂéÜÂè≤ËÆ∞ÂΩï
    async getUserMenuRecord() {
      var userId = JSON.parse(window.sessionStorage.getItem("user")).userId;
      const { data: userMenuRecordRes } = await this.$http.get(
        "record/" + userId
      );
      this.userMenuRecord = userMenuRecordRes.data;
    },

    //ÊêúÁ¥¢ÂäüËÉΩ
    searchMenu() {
      this.menuPart = this.menu;
      this.menuPart = this.searchFilter(this.search);
    },

    //ÊêúÁ¥¢ÂäüËÉΩËøáÊª§Âô®
    searchFilter(search) {
      return this.menu.filter(function (menu) {
        return (
          menu.menuCuis.includes(search) ||
          menu.menuName.includes(search) ||
          menu.menuTaste.includes(search)
        );
      });
    },

    //Ëé∑ÂèñÂîØ‰∏ÄidÁöÑÊñπÊ≥ï
    guid() {
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
        /[xy]/g,
        function (c) {
          var r = (Math.random() * 16) | 0,
            v = c == "x" ? r : (r & 0x3) | 0x8;
          return v.toString(16);
        }
      );
    },

    //Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥ÊñπÊ≥ï
    getNowTime() {
      return this.$moment().format("YYYY-MM-DD HH:mm:ss");
    },

    //Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØ
    updateUserInfo() {
      //Ë°®ÂçïÈ™åËØÅÂºÄÂßã
      this.$refs.userFormRef.validate(async (valid) => {
        //Ë°®ÂçïÈ™åËØÅÂ§±Ë¥•
        if (!valid) {
          this.$message.error("Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÈ™åËØÅÂ§±Ë¥•");
          return;
        }
        //Ë°®ÂçïÈ™åËØÅÈÄöËøá
        this.user.userAdd = this.getLocationTransform(this.user.userAdd);
        this.user.userLike = this.dynamicUserLikeTags.join("|");
        //ÂèëËµ∑ËØ∑Ê±Ç
        const {data: userRes} = await this.$http.put("user", this.user);
        if (userRes.code !== 200) {
          this.$message.error("Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÂ§±Ë¥•!")
          this.getUser();
          return;
        }
        this.getUser();
        this.$message.success("Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÊàêÂäü");
      });
    },

    //Â∞ÜÁî®Êà∑ÁöÑÂüéÂ∏ÇÁºñÂè∑ËΩ¨Âåñ‰∏∫‰∏≠ÊñáÊòæÁ§∫
    getLocationTransform(cityArr) {
      //Â∞ÜÊâÄÈúÄË¶ÅÁöÑÂüéÂ∏ÇÁºñÁ†Å‰ø°ÊÅØÂàóÂá∫Êù•
      const location = cityArr;
      const locationProvince = location[0];
      const locationCity = location[1];
      const locationArea = location[2];
      //ÂàõÂª∫Êï∞ÁªÑ‰øùÂ≠òÊü•ËØ¢Âà∞ÁöÑÊï∞ÁªÑÔºåÂáèÂ∞ëÊü•ËØ¢Ê¨°Êï∞
      var provinceArr = [];
      var cityArr = [];
      //ÊúÄÂêéÁî®‰∫éÂ≠òÊîæÂüéÂ∏Ç‰∏≠ÊñáÂ≠óÁ¨¶ÁöÑÂ≠óÁ¨¶‰∏≤
      var tansformLocation = "";
      //Á¨¨‰∏ÄÊ¨°ÂæóÂà∞ÁúÅÂíåÂ∏ÇÁ∫ßÊï∞ÁªÑ
      this.citys.forEach((item) => {
        if (item.value === locationProvince) {
          tansformLocation = tansformLocation + item.label;
          provinceArr = item.children;
        }
      });
      //Á¨¨‰∫åÊ¨°ÂæóÂà∞Â∏ÇÂíåÂå∫ÂüüÁ∫ßÊï∞ÁªÑ
      provinceArr.forEach((item) => {
        if (item.value === locationCity) {
          tansformLocation = tansformLocation + "/" + item.label;
          cityArr = item.children;
        }
      });
      //Á¨¨‰∏âÊ¨°ÂæóÂà∞ÂÆåÊï¥ÁúÅÂ∏ÇÂå∫Â≠óÁ¨¶‰∏≤
      cityArr.forEach((item) => {
        if (item.value === locationArea) {
          tansformLocation = tansformLocation + "/" + item.label;
        }
      });
      //ËøîÂõûËØ•Â≠óÁ¨¶‰∏≤
      return tansformLocation;
    },

    //Â§ÑÁêÜÂéüÊñôtagÂÖ≥Èó≠‰∫ã‰ª∂
    handleUserLikeClose(tag) {
      this.dynamicUserLikeTags.splice(this.dynamicUserLikeTags.indexOf(tag), 1);
    },

    //Â§ÑÁêÜÂØπ‰∫étagÂõûËΩ¶‰∫ã‰ª∂ÊàñÂ§±ÂéªÁÑ¶ÁÇπÁöÑÊñπÊ≥ïÔºåÊ∑ªÂä†Êñ∞ÁöÑÁî®Êà∑ÂñúÂ•Ω
    handleInputConfirm() {
      let inputValue = this.inputUserLikeValue;
      if (inputValue) {
        this.dynamicUserLikeTags.push(inputValue);
      }
      this.inputUserLikeVisible = false;
      this.inputUserLikeValue = "";
    },

    //ÁÇπÂáªÊñ∞+ÂñúÂ•Ω‰∫ã‰ª∂Ëß¶ÂèëÊñπÊ≥ï
    showInput() {
      this.inputUserLikeVisible = true;
      this.$nextTick((_) => {
        this.$refs.saveTagInput.$refs.input.focus();
      });
    },

    //‰øÆÊîπÁî®Êà∑ÂØÜÁ†ÅÊñπÊ≥ï
    async editUserPassword() {
      this.$prompt("ËØ∑ËæìÂÖ•Êñ∞ÂØÜÁ†Å", "ÊèêÁ§∫", {
        confirmButtonText: "Á°ÆÂÆö",
        cancelButtonText: "ÂèñÊ∂à",
        center: true,
        roundButton: true,
        inputPattern: /^[a-zA-Z0-9]{6,13}$/,
        inputErrorMessage: "ÂØÜÁ†ÅÊ†ºÂºè‰∏çÁ¨¶",
      })
        .then(async ({ value }) => {
          const { data: editUserPasswordRes } = await this.$http.post(
            "user/password/" + this.user.userId,
            {
              password: value,
            }
          );
          if (editUserPasswordRes.code !== 200) {
            this.$message.error("‰øÆÊîπÂØÜÁ†ÅÂ§±Ë¥•");
            return;
          } else {
            this.$message({
              type: "success",
              message: `‰Ω†ÁöÑÊñ∞ÂØÜÁ†ÅÊòØ: ${value}| 2ÁßíÂêéÈáçÊñ∞ÁôªÂΩï`,
              duration: 3000,
              center: true,
            });
            setTimeout(() => {
              this.$router.push("login");
            }, 2000);
          }
        })
        .catch(() => {
          this.$message({
            type: "info",
            message: "ÂèñÊ∂à‰øÆÊîπ",
          });
        });
    },

    //Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ËèúË∞±ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ËèúË∞±ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
    async getUserMenu() {
      var userMenuRecord = this.userMenuRecord;
      var menuIdsArr = [];
      userMenuRecord.forEach((item) => {
        menuIdsArr.push(`${item.menuId}`);
      });
      const { data: userMenu } = await this.$http.post("menu/user/menuinfo", {
        menuIdsArr: menuIdsArr,
      });
      if (userMenu.data.length > 0) {
        userMenu.data.sort(function (a, b) {
          return b.count - a.count;
        });
      }
      return userMenu.data;
    },

    //Ê†πÊçÆÁî®Êà∑ÂñúÂ•Ω‰ªéÂ∑≤ÊúâËèúË∞±ÁîüÊàêÊé®ËçêËèúË∞±
    async getRecommendUserLikeMenu() {
      //ÂΩìÂâçÁî®Êà∑
      var user = JSON.parse(window.sessionStorage.getItem("user"));
      this.userLikeMenu = [];
      //Ê†πÊçÆÁî®Êà∑‰ø°ÊÅØÂÜÖÁöÑÂñúÂ•Ω‰ø°ÊÅØËøõË°åÊé®Ëçê
      const { data: userLikeMenuRes } = await this.$http.get(
        "menu/searchlike/" + user.userLike
      );
      for (let i = 0; i < parseInt(userLikeMenuRes.data.length * 0.2); i++) {
        this.userLikeMenu.push(
          userLikeMenuRes.data[parseInt(this.getRandom(userLikeMenuRes.data.length))]
        );
      }

      //ÈöèÊú∫Â°ûÂÖ•2‰∏™Âõ∫ÂÆöÊñ∞ËèúË∞±
      for (let i = 0; i < 1; i++) {
        this.userLikeMenu.push(
          this.menu[parseInt(this.getRandom(this.menu.length))]
        );
      }

      //Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ËèúË∞±ÂéÜÂè≤ËÆ∞ÂΩï
      this.getUserMenu().then((data) => {
        for (let i = 0; i < parseInt(data.length * 0.2); i++) {
          this.userLikeMenu.push(data[parseInt(this.getRandom(data.length))]);
        }
        //ÂéªÈô§ÈáçÂ§çËèúË∞±,Êé®ËçêÁÆóÊ≥ïÁªìÊùü
        for (let i = 0; i < this.userLikeMenu.length - 1; i++) {
          for (let j = i + 1; j < this.userLikeMenu.length; j++) {
            if (this.userLikeMenu[i].menuId === this.userLikeMenu[j].menuId) {
              this.userLikeMenu.splice(j, 1);
              j--;
            }
          }
        }
      });
    },
  },
  mounted() {
    this.getUser();
    this.getMenu();
    this.getUserMenuRecord();
    this.getRecommendUserLikeMenu();
  },
};
</script>
